# HELP
このドキュメントビュアはタグベースのものである。見たいタグにジャンプしてその中身を確認せよ
ドキュメントをすすめるためにはなにかキーを押下せよ。
もしその場で終了したい場合は`q`を押下せよ。

# BASIC言語の書式
BASICプログラムの記述は、行番号式、ラベル式、その混合、いずれの方法でも構わない。以下、仕様について述べる

# 利用可能な変数型
利用可能な変数型は整数型と文字列型のに種類である。文字列のまったんには0が入る

A-Zのあわせて26この整数型変数が利用可能だ。文字列を扱う場合はA$というように記述する。ただし、A(整数型)とA$(文字列型)は同時に利用できない。

整数型の定数は10進法で書く。16進法で書く場合は`$`もしくは"0x"を先頭につけ、"$F7"や"0xF7"というように記述する。
文字リテラルは`"`で囲って記述する

# 命令セット読み方
x,y,zは整数値
x$,y$,z$は文字列
x#,y#,z#は浮動小数点
を示します。任意の状態を示す。[]は省略可能であることを示す
命令動詞を`:`で区切ることで、一行で複数コマンドを処理できる


# BASIC(システム関係)
`END`
 BASICプログラムを停止する
`SYSTEM x , y`
 様々なシステム値の設定を行なう。#　SYSTEMの項を参照
`WAIT x`
 xで示された時間、プログラムの実行を停止する。xが60の場合、約1秒間停止
`REM xxx`
 何も実行しない(コメント)
`EXEC x[,y[,z[...]]]`
 機械語を実行する。ただし、x,y,zは32ビット整数値
`GOTO xxx`
 xxx行目(もしくはラベル)に移動する
`IF xまたはx#　THEN yyy [ ELSE zzz ]`
 xが0以外のとき、yyyを、0のときzzzを実行。yyyおよびzzzは、複数のステート メントを「:」で挟んで記述可能
```
IF xまたはx#　THEN
xxx
[ELSEIF yまたはy#　THEN
yyy]
[ELSE
zzz]
ENDIF
```
 xが0以外の時xxxを、それ以外で且つyが0以外の時（記述された場合）yyyを、それ以外の場合にzzzを実行。ELSEIFステートメントは、複数記述可。各行で、THENステートメントの次には何も記入しないことに注意
LABEL xxx
 GOTO/GOSUBのジャンプ先を登録する。xxxは、英数字6文字以内の文字列

# BASIC(データ関係)
CDATA x[,y[,z[...]]]
 データー列を8ビット整数値で指定する
CLEAR
 すべての文字列型変数と整数型配列を破棄し、整数値を０とする。また、 PCGの使用をやめ、表示キャラクターをリセットする
CDATA xxx[,yyy[,zzz[...]]]
 データー列を8ビット整数値で指定する
DATA xxx[,yyy[,zzz[...]]]
 データー列を整数値もしくは文字列で指定する
DIM xxx [, yyy [, zzz [, ... ]]]
 整数型もしくは浮動小数点型の配列を割り当てる xxx,yyy,zzzは、例えば「A(10)」のように記述する。この場合、A(0)から A(10)までの11個の整数型変数が確保される。浮動小数点型配列の場合は、「A#(10)」の様に記述する。多次元配列も、宣言することが出来る
DRAWCOUNT
 DRAWCOUNT値を指定する。DRAWCOUNT値に付いては、DRAWCOUNT()関数を
 参照
[LET] x=yyy
 yで示された計算結果を、x（整数型変数）に代入する。「LET」は省略可
[LET] x#=yyy
 yで示された計算結果を、x（不動州数点方型変数）に代入する。「LET」は省略可
[LET] x$=yyy
 yyyで示された文字列（もしくは連結結果;連結演算子は「+」）を、x$に代入する。「LET」は省略可
VAR xxx [, yyy [, zzz [, ... ]]]
 サブルーチン内で使う、ローカル変数を指定する。xxx, yyy等は、A-Zのアルファベットで指定する
POKE x,y
 xで示される物理的アドレスに、yで示される値(1バイト値)を書き込む
RESTORE xxx
 DATA読み出し開始位置を指定。xxxは行番号もしくはラベル
RETURN
 最後に実行されたGOSUB文の次のステートメントに移動する。戻り値を指定することがができる。この場合の戻り値はGOSUB()関数にて取得が可能

# BASIC(ループ)
BREAK
 FOR-NEXT, DO-LOOP, WHILE-WENDループから抜け出す
CONTINUE
 FOR-NEXT, DO-LOOP, WHILE-WENDループ中で、以降のコードをスキップする
DO WHILE x
LOOP
 x が0以外の場合、DO文からLOOP文までのステートメントを繰り返し実行する
DO UNTIL x
LOOP
 x が0の場合、DO文からLOOP文までのステートメントを繰り返し実行する
DO
LOOP WHILE x
 DO文からLOOP文までのステートメントを実行し、x が0以外の場合、繰り返す
DO
LOOP UNTIL x
 DO文からLOOP文までのステートメントを実行し、x が0の場合、繰り返す
FOR x=yyy TO zzz [ STEP www ]
NEXT
 yyyで示された計算結果をxに代入し、xの値がzzzになるまで次のNEXT文までのステートメントを、繰り返し実行する。繰り返しのたび、xの値はwwwずつ増加する（省略された場合は1ずつ）。「NEXT」の次に何も記述しないことに注意
GOSUB xxx [, yyy [, zzz [, ... ]]]
 現在の実行位置を記憶し、xxx行目(もしくはラベル)に移動する。yyy, zzz等は、サブルーチンに引き継がれる引数（ARGS()関数を参照）
WHILE x
WEND
 x が0以外の場合、WHILE文からWEND文までのステートメントを繰り返し実行する


# BASIC(画面制御関数)
BGCOLOR r,g,b
 背景色指定
COLOR x
 テキスト色指定
CLS
 スクリーン消去
CURSOR x,y
 カーソル位置指定
PALETTE n,r,g,b
 パレット指定
PCG x,y,z
 ASCIIコードがxの文字の表示キャラクターを変更する。y,zは、キャラクターデーター。詳細は、下記<PCG>の項を参照
PRINT [ xまたはx$またはx#　[ ,または; [ yまたはy$またはy#　[ ... ]]]]
 ディスプレイに、整数値または文字列を表示する。「;」を使用した場合、次の表示が続けて行われる。「,」を使用した場合、1０文字ずつに区切って表示される。どちらも使用しない場合、次の表示は行を変えて行われる
SCROLL x,y
 画面を横方向、もしくは縦方向(斜めも可)に動かす。動かす方向と大きさは、x, yでそれぞれ、横方向の移動度、縦方向の移動度として指定する
USEGRAPHIC [x]
 グラフィックディスプレイを使用、もしくは使用停止する。x=0で使用停止、x=1で使用、x=2で画面とパレットをクリアーして使用、x=3でグラフィック領域を確保するが表示はキャラクターディスプレイのまま。ただし、グラフィックディスプレイ未使用の状態でx=0の場合は、領域を確保する。xを省略した場合は、x=1と同じ
USEPCG [x]
 PCGを使用、もしくは使用停止する。x=0で使用停止、x=1で使用、x=2でキャラクターをリセットして使用。xを省略した場合は、x=1と同じ
WIDTH x
 キャラクターディスプレイの横幅を文字数で指定。xは30もしくは40

# BASIC(グラフィック関連命令)
BOXFILL [x1,y1],x2,y2[,c]
 座標(x1,y1),(x2,y2)を対角線とするカラーcで塗られた長方形を描画
CIRCLE [x,y],r[,c]
 座標(x,y)を中心に、半径r、カラーcの円を描画
CIRCLEFILL [x,y],r[,c]
 座標(x,y)を中心に、半径r、カラーcで塗られた円を描画
GCLS
 画面クリアー
GCOLOR c
 それぞれの命令で、cを省略した場合の色を指定
GPALETTE n,r,g,b
 パレット指定
GPRINT [x,y],c,bc,s$
 座標(x,y)にカラーcで文字列s$を表示、bc:背景色（負数の場合背景色指定なし）
LINE [x1,y1],x2,y2[,c]
 座標(x1,y1)から(x2,y2)にカラーcで線分を描画
POINT x,y
 グラフィック現在位置を、設定する
PSET [x,y][,c]
 座標(x,y)の位置にカラーcで点を描画
PUTBMP [x,y],m,n,bmp
 横m*縦nドットのキャラクター(bbbで指定)を座標(x,y)に表示。サイズm*nの配列bmpに、単純にカラー番号を並べる。ただし、カラーが0の部分は透明色として扱う。ただし、bmpはラベル名もしくは配列へのポインター

# MUSICシステム
MUSIC命令では、BGM用のデーターを文字列で指定する。文字列の書式は、ABC notationに準拠する。ただし、すべての記法が使えるわけではない。なお、キーや速度などのデフォルト設定値は以下の通りである
Q: 1/4=90
L: 1/8
K: C
BGM演奏時に一度に設定できる音の数は、31までである。これを超えて音楽を再生したい場合は、MUSIC()関数の戻り値を調べ、その値が十分小さくなってから、次のMUSIC命令を実行しなさい
添付のmusic.basに、使い方に関するサンプルがあるので、参考にすること

# SOUNDシステム
SOUND命令では、DATA列のデータを、行番号もしくはラベルで指定する。SOUND命令による効果音再生中は、BGMは再生されない。また、前のSOUNDが終わる前に次のSOUND命令を実行すると、前のSOUNDの再生は停止し新しいSOUNDがすぐに再生される

DATA列では、32ビット整数値として効果音を表現する。この整数値の下位16ビットは周波数の指定である。2048が440Hz(ラの音)に対応する。値が大きくなるほどより低い音が出る。上位16ビットは、音の長さである。1が、1/60秒に相当する。最後に、65535以下の値で、SOUNDの繰り返し回数を指定する。これらのデータの数は、32を超えないようにすること

添付のsound.basに、使い方に関するサンプルがあるので参考にすること


# PCG
PCG(Programmable Character Generator)を用いると、ASCIIコードごとにフォントを指定して、疑似グラフィックスとして表示させることが出来る。使用する場合は、まず`USEPCG`とすること。フォントの変更は、PCGステートメントを用いて、
```
PCG 0x80,0x80402010,0x08040201
```
の様に設定する。この例では、ASCIIコード0x80の文字のフォントを設定し、バックスラッシュの様な記号(左上から右下に向かう斜め線)が表示されるようになる。PCGの利用を停止し、オリジナルのフォントに戻す場合は、`USEPCG 0`とする。再度PCGを使用したい場合は、`USEPCG`とする。先に設定したフォントデーターが、復活する。なお、先に設定したフォントデーターを破棄してPCGの使用を始めたい場合は、`USEPCG 2`とすること

# システム変数
SYSTEM関数及びSYSTEMステートメントを用いて、各種システム情報をやりとりすることが出来る

SYSTEM$(0)
  MachiKania バージョン文字列、"Zoea"を返す
SYSTEM$(1)
  MachiKania バージョン文字列、"1.0"等を返す
SYSTEM$(2)
  BASIC バージョン文字列、"KM-1200"等を返す
SYSTEM$(3)
  現在実行中のHEXファイル名、"ZOEA.HEX"等を返す
SYSTEM(20)
  キャラクターディスプレイ横幅を返す
SYSTEM(21)
  キャラクターディスプレイ縦幅を返す
SYSTEM(22)
  グラフィックディスプレイ横幅を返す
SYSTEM(23)
  グラフィックディスプレイ横幅を返す
SYSTEM(24)
  キャラクターディスプレイ用の指定色を返す
SYSTEM(25)
  グラフィックディスプレイ用の指定色を返す
SYSTEM(26)
  キャラクターディスプレイの、現在のX位置を返す
SYSTEM(27)
  キャラクターディスプレイの、現在のY位置を返す
SYSTEM(28)
  グラフィックディスプレイの、現在のX位置を返す
SYSTEM(29)
  グラフィックディスプレイの、現在のY位置を返す
SYSTEM(40)
  PS/2キーボードを使用中かどうかを返す
SYSTEM(41)
  PS/2キーボード情報、vkeyを返す
SYSTEM(42)
  PS/2キーボード情報、lockkeyを返す
SYSTEM(43)
  PS/2キーボード情報、keytypeを返す
SYSTEM(100)
  変数格納領域(g_var_mem)へのポインターを返す
SYSTEM(101)
  乱数シードへのポインターを返す
SYSTEM(102)
  キャラクターディスプレイ領域(TVRAM)へのポインターを返す
SYSTEM(103)
  フォント領域へのポインターを返す
SYSTEM(104)
  PCGフォント領域へのポインターを返す
SYSTEM(105)
  グラフィックディスプレイ領域へのポインターを返す
SYSTEM 200,x
  ディスプレイの表示を停止(xが0のとき)、もしくは開始(xが0以外の時)する


# ヒント
FOR-NEXTループ、WHILE-WENDループ、DO-LOOPループの途中で、GOTO文でループの外に飛んだり、RETURN文を実行したりすると、予期せぬ結果（機器のリセット等）を引き起こす。ただし、GOSUB文でサブルーチンを呼んだり、別のループをネストして使う事は可能である

ON GOTO分やON GOSUB文はサポートしていない。ただし、例えば次のように記述することで、同様の動作をさせることが可能だ
 ```
GOSUB 10000+A
 ....
 10000 PRINT "A=0" : RETURN
 10001 PRINT "A=1" : RETURN
 10002 PRINT "A=2" : RETURN
```
一行中で連続して文字列を扱うと、"String too complexed"というエラーがでて、停止することがある。この場合は、文字列を扱う命令を独立した行するか、文字列関連の演算を幾つかのステップに分けて、それぞれ1行ずつの記述にして試みなさい

# バージョン履歴
・KM-1202 2016年10月公開。
  1．WIDTHステートメントを追加。
  2．特殊なデーター列・文字列に於ける、リンク時の不具合及びREAD()関数実行時に於ける不具合を修正。
  3．多次元配列中で演算子を使った場合の不具合を解消。
・KM-1201 2016年9月公開。
  1．CONTINUEステートメントを追加。
  2．ATAN2#()関数を追加。
  3．IF-THEN-ELSEステートメントでエラーがでる不具合を修正。
  4．負の実数値の扱いにおける不具合を修正。
・KM-1200 2016年8月公開。
  1．グラフィックディスプレイ機能および、関連のステートメント群を追加。
  2．浮動小数点演算機能、及び、算術演算関数群を追加。
  3．VAR, BREAK, SYSTEMステートメントを追加。
  4．DO-LOOP, WHILE-WENDループ構造文を追加。
  5．IF THEN - ELSEIF - ELSE - ENDIFによる、複数行での条件分岐表現を追加。
  6．GOSUBステートメント及びGOSUB()関数に第二以降の引数を指定出来る様にし、サブルーチン中でARGS()関数により取り出せるようにした。
  7．8ビット整数型を扱うCDATAステートメントとCREAD()関数を追加。
  8．DATAステートメントで文字列を扱える様にし、READ$()で読めるようにした。
  9．多次元配列をサポート。
  10．例外発生時に、情報を表示するようにした。
  11．FOR-NEXTループに於いて、TO値に一致する時だけではなく、値を超えた場合でもループを抜けるようにした。
  12．MUSICステートメント用のスクリプトにエラーがある際、エラー発生行が正しく表示されない不具合を修正。
  13．ビットシフト演算子を、追加。

・KM-1120 2016年2月公開。
  1．PCG機能を追加。
  2．SCROLL命令を追加。
  3．WAIT命令を追加。
  4．「Ctrl+Break」キーによる実行停止に対応。
  5．FOR無しでNEXTを実行した場合、GOSUB無しでRETURNを実行した場合にエラーを表示して停止するようにした。

・Ver 1.1.0 (KM-1110) 2015年12月公開。
  1．2015年11月21日に変更されたPIC32TVGSの仕様に対応。
  2．PS/2キーボードに対応。
  3．INKEY() INPUT$() VAL() DEC$() の4つの関数を追加。
  4．TVRAM() ASC() PEEK()が、0x80-0xFFの値に関して負の数を返していた不具合を修正。
  5．DIMステートメントにより配列を定義した際、すべての要素がゼロになるようにした。
  6．単項演算子、「-」「+」を追加。
  7．LABEL定義されていない飛び先にGOTOするとリセットされる不具合を修正。
  8．同一のLABELを複数回使用している場合に、コンパイルエラーが出るように修正。
  9．引数を持たないPRINT文に対応。

・Ver 1.0.5 (KM-1100) 最初の正規公開バージョン。
